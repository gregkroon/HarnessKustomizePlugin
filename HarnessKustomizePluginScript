cd /root/K_PLUGINS/kustomize/plugin/version1/harnesskustomizeplugin
rm  HarnessKustomizePlugin

#generate plugin script
cat <<'EOF' >  HarnessKustomizePlugin
#!/bin/sh

#Setup GIT config 
git config --global user.email "git email address"
git config --global user.name "git user"

# capture standad input to file for yq processing 
cat -> input.yaml

# create update for commit to GIT
yq eval '(.spec.template.spec.containers[].image = "${artifact.metadata.image}")'  deployment.yaml > deployment.yaml.new
rm deployment.yaml
mv deployment.yaml.new deployment.yaml

git pull  > /dev/null 2>&1
git add -f deployment.yaml > /dev/null 2>&1
git commit -m "Automated commit"  > /dev/null 2>&1
git remote set-url origin https://username:password@github.com/user/repo.git > /dev/null 2>&1
git push --set-upstream origin main > /dev/null 2>&1

#Process input file and transform for plugin stdout (this is where we inject the harness ${artifact.metadata.image} variable

yq eval '(.spec.template.spec.containers[].image = "${artifact.metadata.image}")'  input.yaml
EOF

#Set plugin script permissions 
chmod +x HarnessKustomizePlugin
